<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í•˜ì€ì•±-ì´ë¯¸ì§€ê²Œì„</title>
  <style>
    :root{
      --gap: clamp(8px, 1.2vw, 14px);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html, body{width:100%; height:100%; margin:0; overflow:hidden; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;}
    body{background:linear-gradient(180deg,#fff 0%,#fafafa 100%);}

    .panel{
      width:100%; height:100%;
      display:grid; grid-template-rows:auto 1fr; gap:var(--gap); padding:var(--gap);
    }

    /* ===== í—¤ë” ===== */
    .head{
      position:sticky; top:0; z-index:10;
      padding: var(--gap) 16px;   /* ì¢Œìš° ì—¬ë°± ì¶”ê°€ */
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      border-bottom:1px solid #e9e9ee;
      box-shadow:0 2px 12px rgba(0,0,0,.04);
      transition:padding .2s ease;
    }

    /* í—¤ë” ë‚´ë¶€ ë ˆì´ì•„ì›ƒ: ì¢Œ(ë’¤ë¡œê°€ê¸°) + ì¤‘ì•™/ì˜¤ë¥¸ìª½ */
    .head-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
    .back-btn {
      font-size: 28px;
      font-weight: 900;  /* ê¸°ì¡´ boldë³´ë‹¤ ë” êµµê²Œ */
      padding: 10px 16px;
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      appearance: none;
      border: 0;
      background: transparent;
      cursor: pointer;
      border-radius: 6px;
      transition: color 0.2s ease;
    }

    .back-btn:hover {
      color: #374151;
      background-color: rgba(0, 0, 0, 0.05); /* ì•½ê°„ ë°°ê²½ ì¶”ê°€í•´ì„œ í˜¸ë²„ê° ë” ì¢‹ê²Œ */
    }

    /* ì¹´í…Œê³ ë¦¬ ì¤„ */
    .cats-wrap{ display:flex; justify-content:center; }
    .head.collapsed .cats-wrap{ display:none; } /* â† ì ‘íˆë©´ ì™„ì „íˆ ê°ì¶¤ */

    /* íƒ­(ì¹´í…Œê³ ë¦¬) */
    .cats{
      display:flex; gap:18px; align-items:center; overflow-x:auto; scrollbar-width:none; padding:2px 8px 4px;
    }
    .cats::-webkit-scrollbar{display:none;}
    .tab {
      appearance: none;
      background: transparent;
      border: 0;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      padding: 10px 12px 12px;
      font-weight: 900;
      font-size: 18px;
      color: #6b7280;
    }
    .tab:hover{color:#374151;}
    .tab.active{color:#111827;}
    .tab.active::after{
      content:''; position:absolute; left:6px; right:6px; bottom:0; height:3px; background:#111827; border-radius:999px;
    }

    /* íˆ´ë°” ì¤„ */
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      overflow-x:auto; scrollbar-width:none;
    }
    .toolbar::-webkit-scrollbar{display:none;}

    .seg {
      display: flex;
      gap: 6px;
      padding: 6px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      align-items: center;
    }
    .seg-btn {
      appearance: none;
      background: transparent;
      border: 0;
      cursor: pointer;
      padding: 10px 18px; /* íŒ¨ë”© í‚¤ì›€ */
      border-radius: 8px;
      font-weight: 900;   /* bold ì •ë„ ë§ì¶¤ */
      font-size: 18px;    /* í°íŠ¸ í‚¤ì›€ */
      color: #374151;
      white-space: nowrap;
    }
    .seg-btn:hover{background:#f3f4f6;}
    .seg-btn.active{background:#111827; color:#fff;}

    /* ì¤‘ì•™: ë’¤ì§‘ê¸° ì°¬ìŠ¤ */
    .toolbar-hint-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }
    #hintBtn.hint-big {
      font-size: 18px;
      font-weight: 900;
      background: #facc15;
      color: #111827;
      border: none;
      padding: 12px 24px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease;
    }
    #hintBtn.hint-big:hover {
      background: #eab308;
    }
    #hintBtn.hint-big:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .toolbar-actions{ display:flex; gap:10px; align-items:center; }
    /* í•œë²ˆë”í•˜ê¸° ë²„íŠ¼ */
    .btn.secondary {
      font-size: 18px;
      font-weight: 900;
      background: #111827;
      color: #fff;
      border: 1px solid #111827;
      cursor: pointer;
      padding: 12px 24px;
      border-radius: 999px;
      white-space: nowrap;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: background 0.2s ease;
    }
    .btn.secondary:hover {
      background: #0f172a;
      border-color: #0f172a;
    }

    /* ì¹´í…Œê³ ë¦¬ ë³´ì´ê¸° ë²„íŠ¼ (ì•„ì´ì½˜ ì „ìš©) */
    .pill-toggle {
      width: 36px;          /* ì •ì‚¬ê°í˜• ë²„íŠ¼ */
      height: 36px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 50%;   /* ë™ê·¸ë—ê²Œ */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: background 0.2s ease;
      padding: 0;           /* ê¸€ì ê³µê°„ ì œê±° */
    }
    .pill-toggle:hover {
      background: #f3f4f6;
    }
    .pill-toggle .chev {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-right: 2px solid #111827;
      border-bottom: 2px solid #111827;
      transform: rotate(45deg);
      transition: transform 0.2s ease;
    }
    /* ì ‘í˜”ì„ ë•Œ ìœ„ìª½ í™”ì‚´í‘œ */
    .head.collapsed .pill-toggle .chev {
      transform: rotate(-135deg);
    }

    /* ===== ê·¸ë¦¬ë“œ/ì¹´ë“œ ===== */
    #grid{
      --size:120px; --cols:4;
      display:grid; gap:var(--gap); justify-content:center; align-content:center;
      grid-template-columns:repeat(var(--cols),var(--size)); grid-auto-rows:var(--size);
      height:100%;
    }
    .card{
      width:var(--size); height:var(--size);
      cursor:pointer; border-radius:12px; background:#fff;
      border:2px solid #3b3b3b; box-shadow:0 4px 12px rgba(0,0,0,.15);
      transform-style:preserve-3d; transition:transform .25s cubic-bezier(.25,.8,.25,1); position:relative;
    }
    .card.flip{ transform:rotateY(180deg); }
    .face{ position:absolute; inset:0; border-radius:inherit; overflow:hidden; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; }
    .front{ transform:rotateY(180deg); background:#fff; }
    .face img{ max-width:80%; max-height:80%; object-fit:contain; }
    .face img.fill{ width:100%; height:100%; object-fit:cover; object-position:center; border-radius:inherit; }
    .back {
      transform: rotateY(0deg);
      background: repeating-linear-gradient(
              45deg,
              #f9fafb,
              #f9fafb 10px,
              #e5e7eb 10px,
              #e5e7eb 20px
      );
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .back::after {
      content:'';
      width:100%; height:100%;
      background:url('../assets/images/common/card_back.png') no-repeat center;
      background-size:65%;
    }
    .matched .front{ filter:saturate(.92) opacity(.85); }

    .hint-overlay {
      position: fixed;
      inset: 0;
      z-index: 9998;
      background: rgba(0, 0, 0, 0.25); /* ë°˜íˆ¬ëª… */
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto; /* í´ë¦­ ë§‰ìŒ */
      font-size: 8vw;
      font-weight: 900;
      color: white;
      text-shadow: 0 4px 12px rgba(0,0,0,0.7);
      user-select: none;
    }
    .hint-overlay.hidden {
      display: none;
    }

    .start-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .start-btn {
      font-size: 8vw;
      font-weight: 900;
      padding: 20px 40px;
      background: #111827;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      user-select: none;
      transition: background 0.3s ease;
    }
    .start-btn:hover {
      background: #374151;
    }

    .cancel-btn {
      font-size: 8vw;
      font-weight: 900;
      padding: 20px 40px;
      background: white;
      color: #111827;
      border: 2px solid #111827;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      user-select: none;
      transition: background 0.3s ease, color 0.3s ease;
      margin-top: 20px;
    }
    .cancel-btn:hover {
      background: #f3f4f6; /* ì•½ê°„ ë°ê²Œ */
      color: #000000;
    }

    .hint-countdown {
      animation: scalePop 0.6s ease;
      font-size: 18vw; /* ì¶”ê°€: ìˆ«ì ìì²´ í¬ê¸°ë„ í‚¤ì›€ */
      opacity: 0.65;
    }

    @keyframes scalePop {
      0%   { transform: scale(1); opacity: 0; }
      50%  { transform: scale(2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .card .cover-black {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      border-radius: inherit;
      z-index: 5;
      pointer-events: none;
      display: none;
    }

    /* íŒíŠ¸ ì¤‘ì´ë©´ í‘œì‹œ */
    .card.hint-hide .cover-black {
      display: block;
    }

    /* ===== WIN MODAL ===== */
    .modal {
      position: fixed; inset: 0; z-index: 9999;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .modal.open { display: flex; }

    .modal__box{
      width: min(92vw, 720px);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      overflow: hidden;
    }

    .modal__media-wrap {
      position: relative;
    }
    .modal__label {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 4px 12px rgba(0,0,0,.6);
      pointer-events: none; /* í´ë¦­ ë§‰ì§€ ì•ŠìŒ */
    }

    .modal__media{
      display:block; width:100%; max-height:70vh; object-fit:cover;
      background:#000;
    }

    .modal__footer{
      display:flex; gap:10px; justify-content:center; align-items:center;
      padding:12px 14px; border-top:1px solid #eee; background:#fff;
    }

    .modal__btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 16px; border-radius:10px; font-weight:800; font-size:40px;
    }
    .modal__btn--primary{ background:#111827; color:#fff; }
    .modal__btn--ghost{ background:#f3f4f6; color:#111827; }
  </style>
</head>
<body>
<div class="panel">
  <header class="head collapsed" id="head"><!-- ê¸°ë³¸: ì ‘í˜(1ì¤„) -->
    <div class="head-inner">
      <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
      <button id="backBtn" class="back-btn" aria-label="ë’¤ë¡œê°€ê¸°">â†</button>

      <div style="flex:1;">
        <div class="cats-wrap" id="catsWrap">
          <div class="cats" id="cats"></div>
        </div>

        <div class="toolbar" id="toolbar">
          <div class="seg" id="sizeSeg"></div>

          <!-- ê°€ìš´ë°: ë’¤ì§‘ê¸° ì°¬ìŠ¤ -->
          <div class="toolbar-hint-center">
            <button id="hintBtn" class="hint-big" aria-label="ë’¤ì§‘ê¸° ì°¬ìŠ¤">ğŸ ë’¤ì§‘ê¸° ì°¬ìŠ¤ (2)</button>
          </div>

          <!-- ì˜¤ë¥¸ìª½: í•œë²ˆë”í•˜ê¸° + ì¹´í…Œê³ ë¦¬ -->
          <div class="toolbar-actions">
            <button class="btn secondary" id="btnRefresh">í•œë²ˆ ë”í•˜ê¸°</button>
            <button id="catToggle" class="pill-toggle" aria-expanded="false" aria-controls="catsWrap">
              <span class="chev"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div id="grid"></div>
</div>
<!-- ì˜¤ë²„ë ˆì´ + ì‹œì‘í•˜ê¸° ë²„íŠ¼ -->
<div id="startOverlay" class="hint-overlay hidden">
  <div class="start-buttons">
    <button class="start-btn">ì‹œì‘í•˜ê¸°</button>
    <button class="cancel-btn">ë‹¤ì‹œì„ íƒ</button>
  </div>
</div>
<!-- ì˜¤ë²„ë ˆì´ + ì¹´ìš´íŠ¸ë‹¤ìš´ -->
<div id="hintOverlay" class="hint-overlay" style="display:none;" aria-hidden="true">
  <div class="hint-countdown" id="hintCountdown">3</div>
</div>

<script type="module">
  const grid     = document.getElementById('grid');
  const sizeSeg  = document.getElementById('sizeSeg');
  const catsBar  = document.getElementById('cats');
  const headEl   = document.getElementById('head');
  const btnRefresh = document.getElementById('btnRefresh');
  const catToggle  = document.getElementById('catToggle');
  const catToggleText = document.getElementById('catToggleText');
  const hintOverlay = document.getElementById('hintOverlay');
  const hintCountdown = document.getElementById('hintCountdown');
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.querySelector('.start-btn');
  const cancelBtn = document.querySelector('.cancel-btn');
  const hintBtn = document.getElementById('hintBtn');
  let hintCount = 2;

  /* ì¹´í…Œê³ ë¦¬ ë§¤í•‘ */
  const CATEGORY_MAP = [
    { id:'fruits',        name:'ê³¼ì¼' },
    { id:'vehicles',      name:'íƒˆê²ƒ' },
    { id:'buttDetective', name:'ì—‰ë©ì´íƒì •' },
    { id:'breadBarber',   name:'ë¸Œë˜ë“œì´ë°œì†Œ' },
    { id:'huntrix',       name:'í—Œí„°ë¦­ìŠ¤' },
    { id:'kids',          name:'í•˜ë¦¼í•˜ì€' },
  ];

  const PRESETS = [[3,4],[4,4],[4,5],[5,4],[5,6],[6,6]];
  const FILL_CATS = new Set(['kids', 'huntrix']); // ê½‰ ì±„ìš¸ ì¹´í…Œê³ ë¦¬

  let rows=4, cols=4;
  let allFiles=[], lock=false, first=null, second=null, matchedPairs=0, totalPairs=0;
  let currentCat = null; // null = ëœë¤

  function $shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
  }

  // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ start-trigger í´ë¦­ ì²˜ë¦¬
  document.body.addEventListener('click', (e) => {
    const trigger = e.target.closest('.start-trigger');
    if (!trigger) return;

    // ì´ˆê¸°í™”
    hintCount = 2;
    hintBtn.textContent = `ë’¤ì§‘ê¸° ì°¬ìŠ¤ (${hintCount})`;
    hintBtn.disabled = false;
    hintBtn.style.opacity = 1;
    hintBtn.style.cursor = 'pointer';

    startOverlay.classList.remove('hidden');
  });

  startBtn.addEventListener('click', () => {
    startOverlay.classList.add('hidden');   // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
    startCountdown();                       // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
  });

  cancelBtn.addEventListener('click', () => {
    startOverlay.classList.add('hidden');   // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
  });

  function startCountdown() {
    showHint(true, 3000);  // ìë™ ì‹¤í–‰: 3ì´ˆ
  }

  function startRefresh() {
    // ì´ˆê¸°í™”
    hintCount = 2;
    hintBtn.textContent = `ë’¤ì§‘ê¸° ì°¬ìŠ¤ (${hintCount})`;
    hintBtn.disabled = false;
    hintBtn.style.opacity = 1;
    hintBtn.style.cursor = 'pointer';
    renderGrid();

    showHint(true, 3000);  // ìë™ ì‹¤í–‰: 3ì´ˆ
  }

  function getCatFromUrl(src){
    const m = src.match(/\/memory\/(?:images\/)?([^/]+)\//);
    return m ? m[1] : null;
  }
  function shouldFill(src){
    const catInUrl = getCatFromUrl(src);
    if (catInUrl && FILL_CATS.has(catInUrl)) return true;
    if (currentCat && FILL_CATS.has(currentCat)) return true;
    return false;
  }

  /* í† ê¸€ ë™ì‘ */
  function setCatsCollapsed(collapsed){
    headEl.classList.toggle('collapsed', collapsed);
    catToggle.setAttribute('aria-expanded', String(!collapsed));
    localStorage.setItem('catsCollapsed', collapsed ? '1' : '0');
    fitGrid(rows, cols);
  }
  catToggle.addEventListener('click', ()=> setCatsCollapsed(!headEl.classList.contains('collapsed')));

  /* ì¹´í…Œê³ ë¦¬ íƒ­ */
  function renderCategories(){
    catsBar.innerHTML = '';
    const tabs = [{ id:null, name:'ëœë¤' }, ...CATEGORY_MAP];
    tabs.forEach(({id,name})=>{
      const b = document.createElement('button');
      b.className = 'tab start-trigger';
      b.textContent = name;
      if (id === currentCat) b.classList.add('active');
      b.addEventListener('click', async ()=>{
        currentCat = id;
        [...catsBar.querySelectorAll('.tab')].forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        await loadList();
        renderSizeSeg();
        renderGrid();
      });
      catsBar.appendChild(b);
    });
  }

  /* í¬ê¸° ì„¸ê·¸ë¨¼íŠ¸ */
  function renderSizeSeg(){
    sizeSeg.innerHTML = '';
    PRESETS.forEach(([r,c])=>{
      const needPairs=(r*c)/2;
      const enough=allFiles.length>=needPairs;
      const btn=document.createElement('button');
      btn.className='seg-btn start-trigger';
      btn.textContent=`${r}Ã—${c}`;
      if(!enough) btn.disabled=true;
      if(r===rows && c===cols) btn.classList.add('active');
      btn.addEventListener('click',()=>{
        if(!enough) return;
        rows=r; cols=c;
        [...sizeSeg.querySelectorAll('.seg-btn')].forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        renderGrid();
      });
      sizeSeg.appendChild(btn);
    });
  }

  /* ìƒˆë¡œê³ ì¹¨ */
  btnRefresh.addEventListener('click', ()=>startRefresh());

  // íŒíŠ¸ ì‹¤í–‰ í•¨ìˆ˜
  function showHint(isAuto = false, duration = 3000) {
    if (lock || (!isAuto && hintCount <= 0)) return;

    const allCards = [...grid.querySelectorAll('.card')];
    if (!allCards.length) return;

    lock = true;

    // íŒíŠ¸ ê°€ë¦¼ ìƒíƒœ ì ìš©
    allCards.forEach(card => {
      if (card.classList.contains('matched')) {
        card.classList.add('hint-hide'); // ê²€ì€ ê°€ë¦¼ë§‰ í‘œì‹œ
      } else {
        card.classList.add('flip');
      }
    });

    showCountdown(duration);

    setTimeout(() => {
      allCards.forEach(card => {
        card.classList.remove('hint-hide'); // ê²€ì€ ê°€ë¦¼ë§‰ ì œê±°
        if (!card.classList.contains('matched')) {
          card.classList.remove('flip');
        }
      });
      lock = false;
    }, duration);

    if (!isAuto) {
      hintCount--;
      hintBtn.textContent = `ë’¤ì§‘ê¸° ì°¬ìŠ¤ (${hintCount})`;
      if (hintCount <= 0) {
        hintBtn.disabled = true;
        hintBtn.style.opacity = 0.6;
        hintBtn.style.cursor = 'not-allowed';
      }
    }
  }

  // íŒíŠ¸ ë²„íŠ¼ í´ë¦­
  hintBtn.addEventListener('click', () => showHint(false, 3000));

  function showCountdown(duration) {
    const seconds = Math.floor(duration / 1000);
    let current = seconds;

    hintOverlay.style.display = 'flex';
    hintOverlay.setAttribute('aria-hidden', 'false');
    hintCountdown.textContent = current;

    const interval = setInterval(() => {
      current--;
      if (current <= 0) {
        clearInterval(interval);
        hintOverlay.style.display = 'none';
        hintOverlay.setAttribute('aria-hidden', 'true');
      } else {
        hintCountdown.textContent = current;
        hintCountdown.classList.remove('hint-countdown'); // íŠ¸ë¦¬ê±° ë¦¬ì…‹
        void hintCountdown.offsetWidth; // reflow
        hintCountdown.classList.add('hint-countdown');
      }
    }, 1000);
  }

  /* ë°ì´í„° ë¡œë“œ */
  async function loadList(){
    try {
      // manifest.json ì „ì²´ë¥¼ ë¶ˆëŸ¬ì˜´
      const r = await fetch('../assets/images/games/memory/manifest.json', { cache: 'no-store' });
      const manifest = await r.json();

      if (currentCat) {
        // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë§Œ
        allFiles = manifest[currentCat] || [];
      } else {
        // ëœë¤(ëª¨ë“  ì¹´í…Œê³ ë¦¬ í•©ì¹¨)
        allFiles = Object.values(manifest).flat();
      }
    } catch {
      allFiles = [];
    }
  }

  /* ë±/ê·¸ë¦¬ë“œ */
  function makeDeck(r,c){
    const total=r*c; if(total%2===1) return [];
    const pairs=total/2; if(allFiles.length<pairs) return [];
    const chosen=$shuffle([...allFiles]).slice(0,pairs);
    return $shuffle([...chosen,...chosen]);
  }

  function fitGrid(rows, cols){
    const panelEl = document.querySelector('.panel');
    const availW  = panelEl.clientWidth;
    const availH  = panelEl.clientHeight - headEl.offsetHeight - 12;

    const gap  = 12;
    const sizeW = Math.floor((availW - (cols - 1) * gap) / cols);
    const sizeH = Math.floor((availH - (rows - 1) * gap) / rows);
    const size  = Math.max(40, Math.min(sizeW, sizeH));

    grid.style.setProperty('--cols', String(cols));
    grid.style.setProperty('--size', (size - 20) + 'px');
  }

  async function renderGrid(){
    lock=false; first=second=null; matchedPairs=0;
    grid.innerHTML='';
    const deck=makeDeck(rows,cols);
    if(!deck.length) return;
    totalPairs=deck.length/2;

    deck.forEach(src => {
      const card = document.createElement('div');
      card.className = 'card';

      const front = document.createElement('div');
      front.className = 'face front';
      const img = document.createElement('img');
      img.src = src;
      if (shouldFill(src)) img.classList.add('fill');
      front.appendChild(img);

      const back = document.createElement('div');
      back.className = 'face back';

      // ê²€ì€ ì˜¤ë²„ë ˆì´ ë ˆì´ì–´ ì¶”ê°€
      const blackCover = document.createElement('div');
      blackCover.className = 'cover-black';
      card.appendChild(blackCover);

      card.appendChild(front);
      card.appendChild(back);

      card.addEventListener('click', () => flip(card, src));
      grid.appendChild(card);
    });
    fitGrid(rows,cols);
  }

  function flip(card,src){
    if(lock||card.classList.contains('flip')||card.classList.contains('matched')) return;
    card.classList.add('flip');
    if(!first){ first={card,src}; return; }
    second={card,src};
    if(first.src===second.src){
      first.card.classList.add('matched'); second.card.classList.add('matched');
      matchedPairs++; first=second=null;
      if (matchedPairs === totalPairs) {
        setTimeout(()=> openWinModal(), 120); // flip ì• ë‹ˆ ëë‚œ ë’¤ ì‚´ì§ ë”œë ˆì´
      }
    }else{
      lock=true;
      setTimeout(()=>{ first.card.classList.remove('flip'); second.card.classList.remove('flip'); first=second=null; lock=false; },650);
    }
  }

  window.addEventListener('resize', ()=>fitGrid(rows,cols));

  /* init */
  (async()=>{
    // ê¸°ë³¸ì€ í¼ì¹¨(true)
    let collapsed = false;

    // localStorage ê°’ì´ ìˆìœ¼ë©´ ë³µì›
    const saved = localStorage.getItem('catsCollapsed');
    if (saved !== null) {
      collapsed = saved === '1';
    }

    setCatsCollapsed(collapsed);  // <- ì´ê±¸ë¡œ ë°˜ì˜

    currentCat = null;
    renderCategories();
    await loadList();

    // ê¸°ë³¸ì€ 4x5
    rows = 4;
    cols = 5;

    // ë§Œì•½ ì´ë¯¸ì§€ê°€ ë¶€ì¡±í•˜ë©´ fallback
    if (allFiles.length < (rows * cols / 2)) {
      const start = PRESETS.find(([r,c])=> allFiles.length >= (r*c/2)) || PRESETS[0];
      rows = start[0];
      cols = start[1];
    }

    renderSizeSeg();
    renderGrid();

    startOverlay.classList.remove('hidden');
  })();

  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  const backBtn = document.getElementById('backBtn');
  backBtn.addEventListener('click', ()=>{
    if (window.history.length > 1) {
      // ì´ì „ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ì´ë™
      window.history.back();
    } else {
      // ì—†ìœ¼ë©´ ë©”ì¸ìœ¼ë¡œ ê°•ì œ ì´ë™
      window.location.href = '/index.html';
    }
  });
</script>

<!-- WIN MODAL -->
<div id="winModal" class="modal" aria-hidden="true" role="dialog" aria-label="ì¶•í•˜ ëª¨ë‹¬">
  <div class="modal__box" role="document">
    <div class="modal__media-wrap">
      <video id="winVideo" class="modal__media" playsinline muted preload="auto">
        <source src="/assets/media/common/fanfare.mp4" type="video/mp4">
        <source src="/assets/media/common/fanfare.mov" type="video/quicktime">
      </video>
      <!-- ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ -->
      <div class="modal__label"></div>
    </div>
    <!--        <div class="modal__footer">-->
    <!--            <button id="replayBtn" class="modal__btn modal__btn&#45;&#45;ghost">ë‹¤ì‹œë³´ê¸°</button>-->
    <!--            <button id="closeBtn"  class="modal__btn modal__btn&#45;&#45;primary">ë‹«ê¸°</button>-->
    <!--        </div>-->
  </div>
</div>
<script>
  // ====== Win Modal logic (robust) ======
  const winModal = document.getElementById('winModal');
  const winVideo = document.getElementById('winVideo');
  const replayBtn = document.getElementById('replayBtn');
  const closeBtn  = document.getElementById('closeBtn');

  // í›„ë³´ ì†ŒìŠ¤ (MP4 ìš°ì„ )
  const VIDEO_SOURCES = [
    { src: '../assets/media/common/fanfare.mp4', type: 'video/mp4' },
    { src: '../assets/media/common/fanfare.mov',    type: 'video/quicktime' },
  ];

  // ë¸Œë¼ìš°ì € ì§€ì› í˜•ì‹ ì¤‘ ìµœì  ì†ŒìŠ¤ ê³ ë¥´ê¸°
  function pickBestSource() {
    const can = (type) => (winVideo.canPlayType && winVideo.canPlayType(type)) || '';
    // MP4(H.264/AAC) ìš°ì„ 
    if (can('video/mp4; codecs="avc1.42E01E, mp4a.40.2"') || can('video/mp4')) {
      return VIDEO_SOURCES.find(s => s.type === 'video/mp4') || VIDEO_SOURCES[0];
    }
    // ê·¸ ì™¸ì—” MOV ì‹œë„ (ì£¼ë¡œ Safari)
    if (can('video/quicktime')) {
      return VIDEO_SOURCES.find(s => s.type === 'video/quicktime') || VIDEO_SOURCES[0];
    }
    // ê·¸ë˜ë„ ëª¨ë¥´ê² ìœ¼ë©´ ì²«ë²ˆì§¸
    return VIDEO_SOURCES[0];
  }

  async function tryPlayVideo() {
    // iOS/Safari ìë™ì¬ìƒ í˜¸í™˜
    winVideo.muted = true;
    winVideo.playsInline = true;

    try { winVideo.load(); } catch (_) {}

    // ë©”íƒ€ë°ì´í„° ë¡œë“œë˜ë©´ í•œ ë²ˆ ë” ì‹œë„
    const onceCanPlay = new Promise(resolve => {
      const onCanPlay = () => { winVideo.removeEventListener('canplay', onCanPlay); resolve(); };
      winVideo.addEventListener('canplay', onCanPlay, { once: true });
      // í˜¹ì‹œ ì´ë¯¸ ë¡œë“œëìœ¼ë©´ ì¦‰ì‹œ resolve
      if (winVideo.readyState >= 2) { winVideo.removeEventListener('canplay', onCanPlay); resolve(); }
    });

    // ë°”ë¡œ ì‹œë„ + canplay í›„ ì¬ì‹œë„
    try {
      const p = winVideo.play();
      if (p && typeof p.then === 'function') await p;
      return true;
    } catch (_) {
      // ë¬´ì‹œí•˜ê³  canplay í›„ í•œ ë²ˆ ë”
    }

    await onceCanPlay;
    try {
      const p2 = winVideo.play();
      if (p2 && typeof p2.then === 'function') await p2;
      return true;
    } catch (_) {
      // ìë™ì¬ìƒ ì •ì±… ë“±ìœ¼ë¡œ ë§‰íˆë©´ ì»¨íŠ¸ë¡¤ ë…¸ì¶œ
      winVideo.setAttribute('controls', '');
      return false;
    }
  }

  function setVideoSource() {
    const pick = pickBestSource();
    // <source> êµì²´ ëŒ€ì‹  srcë¡œ ì§ì ‘ ì§€ì • (ê°„ê²° & ì‹ ë¢°ì„±â†‘)
    // ê¸°ì¡´ <source> ìì‹ ì œê±°
    while (winVideo.firstChild) winVideo.removeChild(winVideo.firstChild);
    winVideo.removeAttribute('src');
    winVideo.src = pick.src;
    winVideo.type = pick.type || '';
  }

  function openWinModal() {
    setVideoSource();

    // ì—´ê¸°
    winModal.classList.add('open');
    winModal.setAttribute('aria-hidden', 'false');

    // ì¬ìƒ ì‹œë„
    tryPlayVideo();

    // ìë™ ë‹«ê¸°: 6ì´ˆ í›„
    setTimeout(closeWinModal, 6000);
  }

  function closeWinModal() {
    winModal.classList.remove('open');
    winModal.setAttribute('aria-hidden', 'true');
    try { winVideo.pause(); } catch (_) {}
    // ë‹¤ìŒì— ë‹¤ì‹œ ì—´ë©´ ìë™ì¬ìƒ ì‹œë„í•˜ê²Œ ì»¨íŠ¸ë¡¤ ì œê±°
    winVideo.removeAttribute('controls');
  }

  // ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸° (ë°•ìŠ¤ ë‚´ë¶€ í´ë¦­ì€ ì „íŒŒ ë°©ì§€)
  winModal.addEventListener('click', (e) => {
    if (e.target === winModal) closeWinModal();
  });
  const modalBox = winModal.querySelector('.modal__box');
  if (modalBox) {
    modalBox.addEventListener('click', (e) => e.stopPropagation());
  }

  // ë²„íŠ¼ ì•¡ì…˜
  replayBtn.addEventListener('click', () => {
    try {
      winVideo.currentTime = 0;
      winVideo.play().catch(() => {
        winVideo.setAttribute('controls', '');
      });
    } catch (_) {}
  });
  closeBtn.addEventListener('click', closeWinModal);

  // ESCë¡œ ë‹«ê¸°
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && winModal.classList.contains('open')) closeWinModal();
  });

  // ì „ì—­ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ
  window.openWinModal = openWinModal;
  window.closeWinModal = closeWinModal;
</script>
</body>
</html>